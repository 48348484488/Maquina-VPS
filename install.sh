#!/bin/bash

# Instalador Wine Pawn para VS Code v3.2
# Corre√ß√µes: Persist√™ncia total + Avisos ao usu√°rio

clear
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "  üöÄ Instalador Wine Pawn para VS Code v3.2"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""
sleep 1

# [1/8] Verificando extens√µes
echo "üîç [1/8] Verificando extens√µes do VS Code..."
EXT_PAWN_INSTALLED=false
EXT_TASK_INSTALLED=false

if code --list-extensions 2>/dev/null | grep -q "southclaws.vscode-pawn"; then
    EXT_PAWN_INSTALLED=true
    echo "‚úì southclaws.vscode-pawn j√° instalada"
fi

if code --list-extensions 2>/dev/null | grep -q "sanaajani.taskrunnercode"; then
    EXT_TASK_INSTALLED=true
    echo "‚úì sanaajani.taskrunnercode j√° instalada"
fi

if [ "$EXT_PAWN_INSTALLED" = false ] && [ "$EXT_TASK_INSTALLED" = false ]; then
    echo "‚ö†Ô∏è  Nenhuma extens√£o detectada"
fi

sleep 1
echo ""

# [2/8] Verifica√ß√£o de diret√≥rios
echo "üîç [2/8] Verificando estrutura de diret√≥rios..."

if [ -d "pawno" ] || [ -d "pawncc" ]; then
    echo "‚úì Compilador detectado - ser√° preservado"
fi

if [ -d ".vscode" ]; then
    echo "‚ö†Ô∏è  Configura√ß√£o .vscode/ existente - ser√° atualizada"
fi

echo "‚úì Verifica√ß√£o conclu√≠da"
sleep 1
echo ""

# [3/8] Verifica√ß√£o e instala√ß√£o do Wine
echo "üç∑ [3/8] Verificando Wine..."
WINE_ALREADY_INSTALLED=false

if command -v wine >/dev/null 2>&1; then
    EXISTING_WINE_VER=$(wine --version 2>/dev/null)
    if [ -n "$EXISTING_WINE_VER" ]; then
        echo "‚úì Wine j√° instalado: $EXISTING_WINE_VER"
        WINE_ALREADY_INSTALLED=true
    fi
fi

if [ "$WINE_ALREADY_INSTALLED" = false ]; then
    echo "‚è≥ Instalando Wine 32-bit (2-5 minutos)..."
    echo "‚è≥ Aguarde... Este processo pode demorar."
    echo ""
    
    # Limpeza pr√©via
    sudo apt remove --purge wine wine32 wine64 -y >/dev/null 2>&1
    sudo apt autoremove -y >/dev/null 2>&1
    rm -rf ~/.wine
    
    # Configura√ß√£o de reposit√≥rio
    sudo dpkg --add-architecture i386 >/dev/null 2>&1
    sudo apt update >/dev/null 2>&1
    sudo mkdir -pm755 /etc/apt/keyrings >/dev/null 2>&1
    sudo wget -q -O /etc/apt/keyrings/winehq-archive.key https://dl.winehq.org/wine-builds/winehq.key
    sudo wget -q -NP /etc/apt/sources.list.d/ https://dl.winehq.org/wine-builds/ubuntu/dists/jammy/winehq-jammy.sources
    
    # Instala√ß√£o
    sudo apt update >/dev/null 2>&1
    sudo apt install --install-recommends winehq-stable -y >/dev/null 2>&1
    
    # Configura√ß√£o inicial do Wine
    mkdir -p ~/.wine-runtime
    chmod 700 ~/.wine-runtime
    
    export XDG_RUNTIME_DIR=~/.wine-runtime
    export WINEARCH=win32
    export WINEPREFIX=~/.wine
    export WINEDEBUG=-all
    export DISPLAY=:0
    
    wineboot -u >/dev/null 2>&1
    
    # Adicionar ao .bashrc
    if ! grep -q "WINEARCH=win32" ~/.bashrc; then
        echo -e "\n# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" >> ~/.bashrc
        echo "# Configura√ß√£o Wine 32-bit (Auto-start)" >> ~/.bashrc
        echo "# N√ÉO REMOVER - Necess√°rio para compilar Pawn" >> ~/.bashrc
        echo "# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" >> ~/.bashrc
        echo "mkdir -p ~/.wine-runtime 2>/dev/null" >> ~/.bashrc
        echo "export XDG_RUNTIME_DIR=~/.wine-runtime" >> ~/.bashrc
        echo "export WINEARCH=win32" >> ~/.bashrc
        echo "export WINEPREFIX=~/.wine" >> ~/.bashrc
        echo "export WINEDEBUG=-all" >> ~/.bashrc
        echo "export DISPLAY=:0" >> ~/.bashrc
    fi
    
    # Adicionar ao .bash_profile (executado ao fazer login)
    if ! grep -q "WINEARCH=win32" ~/.bash_profile 2>/dev/null; then
        echo -e "\n# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" >> ~/.bash_profile
        echo "# Configura√ß√£o Wine 32-bit (Auto-start)" >> ~/.bash_profile
        echo "# N√ÉO REMOVER - Necess√°rio para compilar Pawn" >> ~/.bash_profile
        echo "# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" >> ~/.bash_profile
        echo "mkdir -p ~/.wine-runtime 2>/dev/null" >> ~/.bash_profile
        echo "export XDG_RUNTIME_DIR=~/.wine-runtime" >> ~/.bash_profile
        echo "export WINEARCH=win32" >> ~/.bash_profile
        echo "export WINEPREFIX=~/.wine" >> ~/.bash_profile
        echo "export WINEDEBUG=-all" >> ~/.bash_profile
        echo "export DISPLAY=:0" >> ~/.bash_profile
    fi
    
    echo "‚úì Vari√°veis configuradas em ~/.bashrc e ~/.bash_profile"
    
    # Recarregar vari√°veis
    source ~/.bashrc 2>/dev/null || true
    
    if command -v wine >/dev/null 2>&1; then
        WINE_VERSION=$(wine --version 2>/dev/null)
        echo "‚úì Wine instalado com sucesso [$WINE_VERSION]"
    else
        echo "‚ùå Falha ao instalar Wine"
        exit 1
    fi
fi

sleep 1
echo ""

# [4/8] VERIFICA√á√ÉO CR√çTICA DO WINE
echo "üîç [4/8] Verificando disponibilidade do Wine..."
source ~/.bashrc 2>/dev/null || true

# For√ßar exporta√ß√£o das vari√°veis
export WINEARCH=win32
export WINEPREFIX=~/.wine
export WINEDEBUG=-all
export XDG_RUNTIME_DIR=~/.wine-runtime

if ! command -v wine >/dev/null 2>&1; then
    echo ""
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo "  ‚ö†Ô∏è  ATEN√á√ÉO: REIN√çCIO NECESS√ÅRIO"
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    echo ""
    echo "O Wine foi instalado mas n√£o est√° dispon√≠vel neste terminal."
    echo ""
    echo "üîÑ SOLU√á√ïES:"
    echo ""
    echo "  1. Execute: source ~/.bashrc"
    echo "  2. OU feche e reabra o terminal"
    echo "  3. OU execute: exec bash"
    echo ""
    read -p "Pressione ENTER para tentar recarregar automaticamente..."
    exec bash "$0"
    exit 0
fi

echo "‚úì Wine dispon√≠vel no PATH"
sleep 1
echo ""

# [5/8] Depend√™ncias
echo "üì¶ [5/8] Verificando depend√™ncias..."
DEPS_ALREADY_INSTALLED=true
MISSING_DEPS=""

command -v unzip >/dev/null 2>&1 || { DEPS_ALREADY_INSTALLED=false; MISSING_DEPS="$MISSING_DEPS unzip"; }
command -v zip >/dev/null 2>&1 || { DEPS_ALREADY_INSTALLED=false; MISSING_DEPS="$MISSING_DEPS zip"; }
command -v wget >/dev/null 2>&1 || { DEPS_ALREADY_INSTALLED=false; MISSING_DEPS="$MISSING_DEPS wget"; }
command -v curl >/dev/null 2>&1 || { DEPS_ALREADY_INSTALLED=false; MISSING_DEPS="$MISSING_DEPS curl"; }

if [ "$DEPS_ALREADY_INSTALLED" = true ]; then
    echo "‚úì Todas as depend√™ncias j√° instaladas"
else
    echo "‚ö†Ô∏è  Instalando depend√™ncias:$MISSING_DEPS"
    sudo apt install -y unzip zip wget curl >/dev/null 2>&1
    echo "‚úì Depend√™ncias instaladas com sucesso"
fi

sleep 1
echo ""
clear

# [6/8] Configura√ß√£o do ambiente VS Code
echo "‚öôÔ∏è  [6/8] Configurando ambiente de desenvolvimento..."

# Criar diret√≥rio .vscode se n√£o existir
mkdir -p .vscode

# Criar settings.json com vari√°veis de ambiente
cat > .vscode/settings.json << 'EOF'
{
    "// ‚ö†Ô∏è  ATEN√á√ÉO": "N√ÉO APAGUE ESTE ARQUIVO!",
    "// Necess√°rio": "Para compilar Pawn com Wine no Codespaces",
    "// Documenta√ß√£o": "https://github.com/seu-repo (adicionar link se tiver)",
    
    "terminal.integrated.env.linux": {
        "WINEARCH": "win32",
        "WINEPREFIX": "${env:HOME}/.wine",
        "WINEDEBUG": "-all",
        "XDG_RUNTIME_DIR": "${env:HOME}/.wine-runtime",
        "DISPLAY": ":0"
    }
}
EOF

echo "‚úì settings.json criado com vari√°veis Wine"

# Baixar tasks.json
echo "‚è≥ Baixando tasks.json..."
wget -q https://github.com/48348484488/Maquina-VPS/raw/74c1d4876c3342d3df52d7db0142fef90f05f4bd/task.zip 2>&1

if [ -f "task.zip" ]; then
    TASK_SIZE=$(du -h task.zip | cut -f1)
    echo "‚úì Download conclu√≠do [$TASK_SIZE]"
    echo ""
    echo "üìÇ Extraindo configura√ß√µes..."
    unzip -q -o task.zip
    rm -f task.zip
    
    # Mover vscode para .vscode se necess√°rio
    if [ -d "vscode" ]; then
        # Preservar settings.json que acabamos de criar
        if [ -f ".vscode/settings.json" ]; then
            mv .vscode/settings.json .vscode/settings.json.backup
        fi
        
        # Mover conte√∫do
        mv vscode/* .vscode/ 2>/dev/null
        rm -rf vscode
        
        # Restaurar settings.json
        if [ -f ".vscode/settings.json.backup" ]; then
            mv .vscode/settings.json.backup .vscode/settings.json
        fi
    fi
    
    if [ -f ".vscode/tasks.json" ]; then
        echo "‚úì tasks.json configurado"
        
        # Adicionar coment√°rio de aviso no tasks.json
        if ! grep -q "N√ÉO APAGUE" .vscode/tasks.json; then
            # Backup do tasks.json original
            cp .vscode/tasks.json .vscode/tasks.json.tmp
            
            # Adicionar aviso no in√≠cio
            cat > .vscode/tasks.json << 'TASKS_HEADER'
{
    "// ‚ö†Ô∏è  ATEN√á√ÉO": "N√ÉO APAGUE ESTE ARQUIVO!",
    "// Necess√°rio": "Para compilar Pawn com Ctrl+Shift+B",
TASKS_HEADER
            
            # Adicionar resto do arquivo (pulando a primeira linha com {)
            tail -n +2 .vscode/tasks.json.tmp >> .vscode/tasks.json
            rm .vscode/tasks.json.tmp
        fi
    else
        echo "‚ùå Erro: tasks.json n√£o encontrado no ZIP"
        exit 1
    fi
else
    echo "‚ùå Falha no download do task.zip"
    exit 1
fi

sleep 1
echo ""

# [7/8] Extens√µes
echo "üîå [7/8] Instalando extens√µes do VS Code..."

if [ "$EXT_PAWN_INSTALLED" = true ] && [ "$EXT_TASK_INSTALLED" = true ]; then
    echo "‚úì Extens√µes j√° instaladas - pulando"
else
    if [ "$EXT_PAWN_INSTALLED" = false ]; then
        echo "‚è≥ Instalando southclaws.vscode-pawn..."
        code --install-extension southclaws.vscode-pawn >/dev/null 2>&1
    fi
    
    if [ "$EXT_TASK_INSTALLED" = false ]; then
        echo "‚è≥ Instalando sanaajani.taskrunnercode..."
        code --install-extension sanaajani.taskrunnercode >/dev/null 2>&1
    fi
    
    sleep 2
    
    EXT_PAWN=$(code --list-extensions 2>/dev/null | grep -c "southclaws.vscode-pawn")
    EXT_TASK=$(code --list-extensions 2>/dev/null | grep -c "sanaajani.taskrunnercode")
    TOTAL_EXT=$((EXT_PAWN + EXT_TASK))
    
    if [ "$TOTAL_EXT" -eq 2 ]; then
        echo "‚úì Extens√µes confirmadas [2/2]"
    elif [ "$TOTAL_EXT" -eq 1 ]; then
        echo "‚ö†Ô∏è  Extens√µes parcialmente instaladas [1/2]"
        echo "‚ö†Ô∏è  Solu√ß√£o: Recarregue a p√°gina (F5)"
    else
        echo "‚ùå Erro ao instalar extens√µes"
        echo "‚ùå Solu√ß√£o: Recarregue a p√°gina (F5)"
    fi
fi

sleep 1
echo ""
clear

# [8/8] Download MediaFire
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "  üì• [8/8] Download do Arquivo MediaFire"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""
echo "Insira a URL completa do MediaFire:"
echo "(Ex: https://www.mediafire.com/file/XXXXXXXXX/arquivo.zip/file)"
echo ""
echo "üí° Dica: Deixe em branco para pular"
echo ""
read -p "üîó URL: " MEDIAFIRE_URL
echo ""

if [ -z "$MEDIAFIRE_URL" ]; then
    echo "‚ö†Ô∏è  URL n√£o fornecida - pulando download"
elif echo "$MEDIAFIRE_URL" | grep -q "mediafire.com"; then
    echo "‚úì URL do MediaFire detectada"
    
    FILE_ID=$(echo "$MEDIAFIRE_URL" | grep -oP '(?<=file/)[^/]+' | head -1)
    
    if [ -n "$FILE_ID" ]; then
        FILENAME=$(echo "$MEDIAFIRE_URL" | grep -oP '(?<=/)[^/]+(?=/file)' | head -1)
        [ -z "$FILENAME" ] && FILENAME="gamemode.zip"
        
        echo "‚òÅÔ∏è  Obtendo link direto..."
        DIRECT_LINK=$(curl -sL "$MEDIAFIRE_URL" | grep -oP 'https://download[0-9]+\.mediafire\.com/[^"]+' | head -1)
        
        if [ -n "$DIRECT_LINK" ]; then
            echo "‚¨áÔ∏è  Baixando $FILENAME..."
            wget -q --show-progress "$DIRECT_LINK" -O "$FILENAME" 2>&1
            
            if [ -f "$FILENAME" ]; then
                echo ""
                echo "‚úì Download conclu√≠do [$(du -h "$FILENAME" | cut -f1)]"
                echo ""
                echo "üìÇ Extraindo arquivos..."
                
                if unzip -q -o "$FILENAME" 2>/dev/null; then
                    rm -f "$FILENAME"
                    echo "‚úÖ Extra√ß√£o conclu√≠da!"
                else
                    echo "‚ùå Erro na extra√ß√£o - arquivo mantido: $FILENAME"
                fi
            else
                echo "‚ùå Falha no download"
            fi
        else
            echo "‚ùå N√£o foi poss√≠vel obter link direto"
        fi
    fi
else
    echo "‚ùå URL inv√°lida - deve ser do MediaFire"
fi

echo ""
sleep 1

# Relat√≥rio final
clear
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo "  ‚úÖ INSTALA√á√ÉO CONCLU√çDA"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
echo ""

# Teste final do Wine
echo "üß™ TESTE FINAL:"
echo ""
if command -v wine >/dev/null 2>&1; then
    echo "  ‚úÖ Wine: $(wine --version 2>/dev/null)"
    echo "  ‚úÖ Caminho: $(which wine)"
else
    echo "  ‚ùå AVISO: Wine n√£o detectado no PATH"
    echo "  üîß Execute: source ~/.bashrc"
fi

# Verificar compilador
echo ""
if [ -f "pawno/pawncc.exe" ]; then
    echo "  ‚úÖ Compilador: pawno/pawncc.exe"
elif [ -f "pawncc/pawncc.exe" ]; then
    echo "  ‚úÖ Compilador: pawncc/pawncc.exe"
else
    echo "  ‚ö†Ô∏è  Compilador: Aguardando arquivo do MediaFire"
fi

# Verificar configura√ß√µes
echo ""
if [ -f ".vscode/settings.json" ] && [ -f ".vscode/tasks.json" ]; then
    echo "  ‚úÖ Configura√ß√£o VS Code: OK"
else
    echo "  ‚ö†Ô∏è  Configura√ß√£o VS Code: Incompleta"
fi

echo ""
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
